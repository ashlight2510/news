name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-pages.yml'
      - 'README.md'
  workflow_dispatch:  # 수동 실행 가능

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Clean root directory
        run: |
          echo "=== Step 1: Cleaning root directory ==="
          # 루트의 모든 파일/폴더 삭제 (frontend, backend, .git, .github 제외)
          find . -maxdepth 1 -mindepth 1 ! -name 'frontend' ! -name 'backend' ! -name '.git' ! -name '.github' -exec rm -rf {} +
          echo "Root directory cleaned"
          ls -la
      
      - name: Copy frontend to root
        run: |
          echo "=== Step 2: Copying frontend files to root ==="
          # frontend 폴더의 모든 내용을 루트로 복사 (숨김 파일 포함)
          shopt -s dotglob
          cp -r frontend/* ./
          shopt -u dotglob
          
          echo "Files copied"
          ls -la | head -30
      
      - name: Create .nojekyll and verify
        run: |
          echo "=== Step 3: Creating .nojekyll and verification ==="
          # .nojekyll 파일 생성 (Jekyll 비활성화 - 필수!)
          touch .nojekyll
          
          echo ""
          echo "=== Final verification ==="
          echo "Root directory contents:"
          ls -la
          echo ""
          echo "Key files check:"
          [ -f index.html ] && echo "✅ index.html" || (echo "❌ index.html MISSING!" && exit 1)
          [ -f CNAME ] && echo "✅ CNAME" || (echo "❌ CNAME MISSING!" && exit 1)
          [ -f .nojekyll ] && echo "✅ .nojekyll" || (echo "❌ .nojekyll MISSING!" && exit 1)
          [ -f robots.txt ] && echo "✅ robots.txt" || echo "⚠️  robots.txt not found"
          [ -f sitemap.xml ] && echo "✅ sitemap.xml" || echo "⚠️  sitemap.xml not found"
          [ -f about.html ] && echo "✅ about.html" || echo "⚠️  about.html not found"
          
          # README.md가 없어야 함
          [ ! -f README.md ] && echo "✅ README.md removed" || (echo "❌ README.md still exists!" && exit 1)
          
          echo ""
          echo "✅ Deployment ready!"
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

