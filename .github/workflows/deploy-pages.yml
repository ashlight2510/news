name: Deploy to GitHub Pages

# 중요: GitHub Pages 설정에서 Source를 "GitHub Actions"로 설정해야 합니다
# Settings → Pages → Source: "GitHub Actions" 선택
# "Deploy from a branch"는 비활성화해야 Jekyll 배포가 실행되지 않습니다

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'public/**'
      - '.github/workflows/deploy-pages.yml'
      - 'README.md'
  workflow_dispatch:  # 수동 실행 가능

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Clean root directory
        run: |
          echo "=== Step 1: Cleaning root directory ==="
          # 루트의 모든 파일/폴더 삭제 (frontend, backend, .git, .github 제외)
          find . -maxdepth 1 -mindepth 1 ! -name 'frontend' ! -name 'backend' ! -name '.git' ! -name '.github' -exec rm -rf {} +
          
          # README.md와 모든 마크다운 파일 명시적으로 삭제 (중요!)
          rm -f README.md *.md
          rm -rf docs/ *.md
          
          echo "Root directory cleaned"
          echo "Remaining files:"
          ls -la
      
      - name: Copy frontend to root
        run: |
          echo "=== Step 2: Copying frontend files to root ==="
          # frontend 폴더의 모든 내용을 루트로 복사 (숨김 파일 포함)
          shopt -s dotglob
          cp -r frontend/* ./
          shopt -u dotglob
          
          # news-summaries.json 확인 (frontend/ 또는 public/에서)
          if [ -f frontend/news-summaries.json ]; then
            echo "✓ news-summaries.json found in frontend/"
          elif [ -f public/news-summaries.json ]; then
            cp public/news-summaries.json ./news-summaries.json
            echo "✓ news-summaries.json copied from public/"
          else
            echo "⚠️  news-summaries.json not found (will be created on next summary run)"
          fi
          
          # README.md가 다시 복사되었을 수 있으므로 다시 삭제
          rm -f README.md *.md
          
          echo ""
          echo "Files copied:"
          ls -la | head -30
          echo ""
          echo "news-summaries.json check:"
          [ -f news-summaries.json ] && echo "✅ news-summaries.json exists" || echo "⚠️  news-summaries.json not found"
      
      - name: Create .nojekyll and verify
        run: |
          echo "=== Step 3: Creating .nojekyll and verification ==="
          
          # 최종 정리: README.md와 모든 마크다운 파일 강제 삭제
          rm -f README.md *.md
          find . -maxdepth 1 -name "*.md" -type f -delete
          
          # .nojekyll 파일 생성 (Jekyll 비활성화 - 필수!)
          # 이 파일이 없으면 GitHub Pages가 Jekyll로 처리하여 README.md를 표시할 수 있음
          touch .nojekyll
          echo "" > .nojekyll
          
          echo ""
          echo "=== Final verification ==="
          echo "Root directory contents:"
          ls -la
          echo ""
          echo "Key files check:"
          [ -f index.html ] && echo "✅ index.html" || (echo "❌ index.html MISSING!" && exit 1)
          [ -f CNAME ] && echo "✅ CNAME" || (echo "❌ CNAME MISSING!" && exit 1)
          [ -f .nojekyll ] && echo "✅ .nojekyll" || (echo "❌ .nojekyll MISSING!" && exit 1)
          [ -f robots.txt ] && echo "✅ robots.txt" || echo "⚠️  robots.txt not found"
          [ -f sitemap.xml ] && echo "✅ sitemap.xml" || echo "⚠️  sitemap.xml not found"
          [ -f about.html ] && echo "✅ about.html" || echo "⚠️  about.html not found"
          [ -f news-summaries.json ] && echo "✅ news-summaries.json" || echo "⚠️  news-summaries.json not found (will be created by summary workflow)"
          
          # README.md와 모든 마크다운 파일이 없어야 함
          if [ -f README.md ] || [ -n "$(find . -maxdepth 1 -name '*.md' -type f)" ]; then
            echo "❌ README.md or other .md files still exist!"
            find . -maxdepth 1 -name '*.md' -type f
            exit 1
          else
            echo "✅ README.md and all .md files removed"
          fi
          
          # index.html이 첫 번째 파일인지 확인
          FIRST_FILE=$(ls -1 | head -1)
          if [ "$FIRST_FILE" = "index.html" ] || [ -f "index.html" ]; then
            echo "✅ index.html is present and will be served as default"
          else
            echo "⚠️  index.html might not be the default file"
          fi
          
          echo ""
          echo "✅ Deployment ready!"
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

